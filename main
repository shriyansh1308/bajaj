package com.test.bajajtest;

import com.test.bajajtest.dto.GenerateResponse;
import com.test.bajajtest.service.BajajService;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
public class BajajTestApplication implements CommandLineRunner {

    private final BajajService bajajService;

    public BajajTestApplication(BajajService bajajService) {
        this.bajajService = bajajService;
    }

    public static void main(String[] args) {
        SpringApplication.run(BajajTestApplication.class, args);
    }

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }

    @Override
    public void run(String... args) throws Exception {

        // üî¥ Put YOUR details here
        String name = "CHITRA SHRIYANSH";
        String regNo = "22BCE9062";
        String email = "shriyansh1308@gmail.com";

        // 1Ô∏è‚É£ API Call to Generate webhook
        GenerateResponse response = bajajService.generate(name, regNo, email);

        System.out.println("Webhook URL: " + response.getWebhookUrl());
        System.out.println("Access Token: " + response.getAccessToken());
        System.out.println("üëâ Open webhook URL to see SQL question");

        // 2Ô∏è‚É£ After solving SQL, update the query below
        String sql = ""SELECT d.DEPARTMENT_NAME, " +
        "AVG(EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM e.DOB)) AS AVERAGE_AGE, " +
        "STRING_AGG(e.FIRST_NAME || ' ' || e.LAST_NAME, ', ' ORDER BY e.EMP_ID LIMIT 10) AS EMPLOYEE_LIST " +
        "FROM DEPARTMENT d " +
        "JOIN EMPLOYEE e ON d.DEPARTMENT_ID = e.DEPARTMENT " +
        "JOIN PAYMENTS p ON e.EMP_ID = p.EMP_ID " +
        "WHERE p.AMOUNT > 70000 " +
        "GROUP BY d.DEPARTMENT_ID, d.DEPARTMENT_NAME " +
        "ORDER BY d.DEPARTMENT_ID DESC;"; // TODO - replace later

        // 3Ô∏è‚É£ Submit final answer
        bajajService.submit(response.getAccessToken(), sql);
        System.out.println("üéØ Done!");
    }
}
